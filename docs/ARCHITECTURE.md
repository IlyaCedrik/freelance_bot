# üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ FreelanceBot

## üìä –û–±—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

FreelanceBot –ø–æ—Å—Ç—Ä–æ–µ–Ω –Ω–∞ –º–æ–¥—É–ª—å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—â–µ–π —á–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –º–µ–∂–¥—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏ —Å–∏—Å—Ç–µ–º—ã.

```mermaid
graph TB
    TG[Telegram] --> WH[Webhook/Polling]
    WH --> BOT[Bot Instance]
    BOT --> MW[Middleware Layer]
    MW --> HD[Handlers]
    MW --> SC[Scenes]
    HD --> SV[Services]
    SC --> SV
    SV --> DB[(Supabase DB)]
    SV --> EXT[External APIs]
    
    subgraph "Core Layers"
        MW
        HD
        SC
        SV
    end
    
    subgraph "Data Layer"
        DB
        EXT
    end
```

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. **Telegram Bot Layer** (`src/bot/`)

#### üìã –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (`src/bot/config/`)
- **`botConfig.js`** - –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞, –∫–æ–º–∞–Ω–¥—ã, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- **`navigationConfig.js`** - –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏—è
- **`actionHandlers.js`** - –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –¥–µ–π—Å—Ç–≤–∏–π

#### üéÆ –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ (`src/bot/handlers/`)
- **`start.js`** - –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
- **`subscription.js`** - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∞–º–∏ –Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
- **`payment.js`** - –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π
- **`referral.js`** - –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∏ –ø—Ä–æ–º–æ–∫–æ–¥—ã
- **`admin.js`** - –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
- **`profile.js`** - –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **`settings.js`** - –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ —ç–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö

#### ‚ö° Middleware (`src/bot/middleware/`)
- **`auth.js`** - –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **`subscription.js`** - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫

#### üé≠ –°—Ü–µ–Ω—ã (`src/bot/scenes/`)
- **`subscription.js`** - –î–∏–∞–ª–æ–≥ –≤—ã–±–æ—Ä–∞ —Ç–∞—Ä–∏—Ñ–∞
- **`payment.js`** - –ü—Ä–æ—Ü–µ—Å—Å –æ–ø–ª–∞—Ç—ã
- **`promoCode.js`** - –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
- **`promoRequest.js`** - –ó–∞–ø—Ä–æ—Å –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤

#### ‚å®Ô∏è –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã (`src/bot/keyboards/`)
- **`main.js`** - –û—Å–Ω–æ–≤–Ω–æ–µ –º–µ–Ω—é
- **`categories.js`** - –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∑–∞–∫–∞–∑–æ–≤
- **`subscription.js`** - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∞–º–∏
- **`admin.js`** - –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å

### 2. **Business Logic Layer** (`src/services/`)

#### üì° –û—Å–Ω–æ–≤–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã:
- **`notificationService.js`** - –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- **`databaseService.js`** - –†–∞–±–æ—Ç–∞ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
- **`jobParser.js`** - –ü–∞—Ä—Å–∏–Ω–≥ –∑–∞–∫–∞–∑–æ–≤ –∏–∑ –∫–∞–Ω–∞–ª–æ–≤
- **`messageFormatter.js`** - –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
- **`scheduler.js`** - –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á
- **`telegramParser.js`** - –ü–∞—Ä—Å–∏–Ω–≥ Telegram —Å–æ–æ–±—â–µ–Ω–∏–π

### 3. **Data Layer** (`src/database/`)

#### üìÇ –ú–æ–¥–µ–ª–∏ (`src/database/models/`)
- **`User.js`** - –ú–æ–¥–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **`Category.js`** - –ú–æ–¥–µ–ª—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
- **`Subscription.js`** - –ú–æ–¥–µ–ª—å –ø–æ–¥–ø–∏—Å–∫–∏
- **`ParsingChannel.js`** - –ú–æ–¥–µ–ª—å –∫–∞–Ω–∞–ª–∞ –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞
- **`Referral.js`** - –ú–æ–¥–µ–ª—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã

#### üîÑ –ú–∏–≥—Ä–∞—Ü–∏–∏ (`src/database/migrations/`)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ö–µ–º—ã

### 4. **Server Layer** (`src/server/`)

- **`expressServer.js`** - HTTP —Å–µ—Ä–≤–µ—Ä –¥–ª—è webhook –∏ API
- Endpoint'—ã –¥–ª—è –∑–¥–æ—Ä–æ–≤—å—è —Å–∏—Å—Ç–µ–º—ã
- –û–±—Ä–∞–±–æ—Ç–∫–∞ webhook'–æ–≤ –æ—Ç Telegram

## üóÑÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã:

```sql
-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
users (
  id: uuid PRIMARY KEY,
  telegram_id: bigint UNIQUE,
  username: text,
  first_name: text,
  created_at: timestamp,
  subscription_end: timestamp,
  trial_used: boolean,
  role: user_role DEFAULT 'user'
)

-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∑–∞–∫–∞–∑–æ–≤
categories (
  id: uuid PRIMARY KEY,
  name: text UNIQUE,
  keywords: text[],
  enabled: boolean DEFAULT true,
  created_at: timestamp
)

-- –ü–æ–¥–ø–∏—Å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
subscriptions (
  id: uuid PRIMARY KEY,
  user_id: uuid REFERENCES users,
  category_id: uuid REFERENCES categories,
  created_at: timestamp
)

-- –ö–∞–Ω–∞–ª—ã –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞
parsing_channels (
  id: uuid PRIMARY KEY,
  channel_id: bigint UNIQUE,
  channel_name: text,
  enabled: boolean DEFAULT true,
  last_message_id: bigint,
  created_at: timestamp
)

-- –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞
referrals (
  id: uuid PRIMARY KEY,
  referrer_id: uuid REFERENCES users,
  referred_id: uuid REFERENCES users,
  created_at: timestamp,
  bonus_paid: boolean DEFAULT false
)

-- –ü—Ä–æ–º–æ–∫–æ–¥—ã
promo_codes (
  id: uuid PRIMARY KEY,
  code: text UNIQUE,
  creator_id: uuid REFERENCES users,
  bonus_days: integer DEFAULT 0,
  discount_percent: integer DEFAULT 0,
  usage_count: integer DEFAULT 0,
  usage_limit: integer,
  created_at: timestamp,
  expires_at: timestamp
)
```

## üîê –°–∏—Å—Ç–µ–º–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### Row Level Security (RLS)

```sql
-- –ü—Ä–∏–º–µ—Ä –ø–æ–ª–∏—Ç–∏–∫–∏ RLS –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
CREATE POLICY "Users can view own data"
  ON users FOR SELECT
  USING (telegram_id = get_current_user_telegram_id());

-- –ü–æ–ª–∏—Ç–∏–∫–∞ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
CREATE POLICY "Admins can view all data"
  ON users FOR ALL
  USING (is_admin(get_current_user_telegram_id()));
```

### –†–æ–ª–∏ –∏ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞:

- **`user`** - –û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
- **`admin`** - –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–∏—Å—Ç–µ–º—ã
- **`super_admin`** - –°—É–ø–µ—Ä–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä

## üìà –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö

### 1. –ü–∞—Ä—Å–∏–Ω–≥ –∑–∞–∫–∞–∑–æ–≤:
```
Telegram Channel ‚Üí Parser ‚Üí Database ‚Üí Notification Service ‚Üí Users
```

### 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
```
User Input ‚Üí Middleware ‚Üí Handler ‚Üí Service ‚Üí Database ‚Üí Response
```

### 3. –°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–ø–∏—Å–æ–∫:
```
User ‚Üí Category Selection ‚Üí Database ‚Üí Scheduler ‚Üí Notifications
```

## üîÑ Lifecycle Events

### –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:
1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Express —Å–µ—Ä–≤–µ—Ä–∞
2. –°–æ–∑–¥–∞–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –±–æ—Ç–∞
3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ middleware –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
4. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
5. –ó–∞–ø—É—Å–∫ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞
6. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ webhook (production) –∏–ª–∏ polling (development)

### –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è:
1. –ü–æ–ª—É—á–µ–Ω–∏–µ update –æ—Ç Telegram
2. –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (middleware)
3. –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∫ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–º—É –æ–±—Ä–∞–±–æ—Ç—á–∏–∫—É
4. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏
5. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
6. –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

## üöÄ –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ:
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ webhook –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤
- –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø–∞—Ä—Å–µ—Ä–∞ –∏ –±–æ—Ç–∞ –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

### –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ:
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- Batch-–æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ú–µ—Ç—Ä–∏–∫–∏:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –°–∫–æ—Ä–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
- –£—Å–ø–µ—à–Ω–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ —Å–µ—Ä–≤–µ—Ä–∞

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:
- –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–π
- –ê—É–¥–∏—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π 